<!DOCTYPE html>
<html lang="en">
<head>
    <title>Pack Fire</title>
    <meta property="og:description" content="Pack Fire Evacuation Zones" />
    <meta charset='utf-8'>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel='stylesheet' href='https://unpkg.com/maplibre-gl@5.6.2/dist/maplibre-gl.css' />
    <script src='https://unpkg.com/maplibre-gl@5.6.2/dist/maplibre-gl.js'></script>
    <script src="https://unpkg.com/@maplibre/maplibre-gl-geocoder@1.5.0/dist/maplibre-gl-geocoder.min.js"></script>
    <link
        rel="stylesheet"
        href="https://unpkg.com/@maplibre/maplibre-gl-geocoder@1.5.0/dist/maplibre-gl-geocoder.css"
    />
    <style>
        body { margin: 0; padding: 0; }
        html, body, #map { height: 100%; }
        #map {
            background: #000;
        }
        .legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            font-family: Arial, sans-serif;
            font-size: 14px;
            z-index: 1;
        }
        .legend h3 {
            margin: 0 0 10px 0;
            font-size: 16px;
            font-weight: bold;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
        }
        .legend-item:last-child {
            margin-bottom: 0;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            border-radius: 3px;
        }
        .legend-timestamp {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #ddd;
            font-size: 12px;
            color: #666;
        }
        .inset-map {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 200px;
            height: 200px;
            z-index: 1;
            background: transparent;
            overflow: hidden;
        }
        .inset-map .maplibregl-map {
            background: transparent;
        }
        .california-label {
            position: absolute;
            top: 40%;
            left: 45%;
            transform: translate(-50%, -50%);
            font-family: Arial, sans-serif;
            font-size: 12px;
            font-weight: normal;
            color: #A7AFB6;
            text-shadow: 
                -2px -2px 0 #ffffff,
                2px -2px 0 #ffffff,
                -2px 2px 0 #ffffff,
                2px 2px 0 #ffffff,
                0 -2px 0 #ffffff,
                0 2px 0 #ffffff,
                -2px 0 0 #ffffff,
                2px 0 0 #ffffff;
            pointer-events: none;
            z-index: 10;
        }
    </style>
</head>
<body>
<div id="map"></div>
<div id="inset-map" class="inset-map">
    <div class="california-label">CALIFORNIA</div>
</div>
<div class="legend">
    <h3>Pack Fire</h3>
    <div class="legend-item">
        <div class="legend-color" style="background-color: #e5a375;"></div>
        <span>Evacuation order</span>
    </div>
    <div class="legend-item">
        <div class="legend-color" style="background-color: #f2ebc7;"></div>
        <span>Evacuation warning</span>
    </div>
    <div class="legend-timestamp">
        Map by Chiara Phillips. Data as of Sat Nov 15 8:39AM Pacific Time (CalFire)
    </div>
</div>
<script>
    const source = 'https://basemaps.cartocdn.com/gl/positron-gl-style/style.json';
    const map = new maplibregl.Map({
        container: 'map',
        style: source,
        zoom: 10,
        center: [-118.7523402087362, 37.563],
    });
    map.on('load', () => {
        fetch('https://services.arcgis.com/BLN4oKB0N1YSgvY8/arcgis/rest/services/CA_EVACUATIONS_CalOESHosted_view/FeatureServer/0/query?where=1%3D1&outFields=*&f=geojson')
        .then(response => response.json())
        .then(data => {
            map.addSource('evacuations', {
                type: 'geojson',
                data: data
            });
            map.addLayer({
                id: 'evacuations-layer',
                type: 'fill',
                source: 'evacuations',
                paint: {
                    'fill-color': [
                    'match',
                    ['get', 'STATUS'],  
                    'Evacuation Order', '#e5a375',    // red
                    'Evacuation Warning', '#f2ebc7',  // orange
                    /* default */ '#999999'
                ],
                    'fill-opacity': 0.8
                }
            });
            map.addLayer({
                id: 'evacuations-outline-layer',
                type: 'line',
                source: 'evacuations',
                paint: {
                    'line-color': [
                    'match',
                    ['get', 'STATUS'],
                    'Evacuation Order', '#d37020',    // darker red
                    'Evacuation Warning', '#e7d98b',  // dark orange
                    /* default */ '#999999'
                ],
                    'line-width': 2
                }
            });
        });
    });
    const geocoderApi = {
        forwardGeocode: async (config) => {
            const features = [];
            try {
                const request =
            `https://nominatim.openstreetmap.org/search?q=${
                config.query
            }&format=geojson&polygon_geojson=1&addressdetails=1`;
                const response = await fetch(request);
                const geojson = await response.json();
                for (const feature of geojson.features) {
                    const center = [
                        feature.bbox[0] +
                    (feature.bbox[2] - feature.bbox[0]) / 2,
                        feature.bbox[1] +
                    (feature.bbox[3] - feature.bbox[1]) / 2
                    ];
                    const point = {
                        type: 'Feature',
                        geometry: {
                            type: 'Point',
                            coordinates: center
                        },
                        place_name: feature.properties.display_name,
                        properties: feature.properties,
                        text: feature.properties.display_name,
                        place_type: ['place'],
                        center
                    };
                    features.push(point);
                }
            } catch (e) {
                console.error(`Failed to forwardGeocode with error: ${e}`);
            }
            return {
                features
            };
        }
    };
    map.addControl(
        new MaplibreGeocoder(geocoderApi, {
            maplibregl
        })
    );
    map.addControl(new maplibregl.NavigationControl({
        showCompass: false
    }), 'bottom-right');
    const insetMap = new maplibregl.Map({
        container: 'inset-map',
        style: {
            version: 8,
            sources: {},
            layers: [{
                id: 'background',
                type: 'background',
                paint: {
                    'background-color': 'transparent'
                }
            }]
        },
        interactive: false,
        attributionControl: false
    });
    insetMap.on('load', () => {
        fetch('california_state.geojson')
        .then(response => response.json())
        .then(data => {
            insetMap.addSource('california-state', {
                type: 'geojson',
                data: data
            });
            insetMap.addLayer({
                id: 'california-state-fill',
                type: 'fill',
                source: 'california-state',
                paint: {
                    'fill-color': '#ffffff',
                    'fill-opacity': 1
                }
            });
            insetMap.addLayer({
                id: 'california-state-outline',
                type: 'line',
                source: 'california-state',
                paint: {
                    'line-color': '#A7AFB6',
                    'line-width': 1
                }
            });
            const bounds = new maplibregl.LngLatBounds();
            if (data.features && data.features.length > 0) {
                data.features.forEach(feature => {
                    if (feature.geometry && feature.geometry.coordinates) {
                        const coords = feature.geometry.type === 'Polygon' 
                            ? feature.geometry.coordinates[0]
                            : feature.geometry.type === 'MultiPolygon'
                            ? feature.geometry.coordinates.flat()
                            : feature.geometry.coordinates;
                        if (Array.isArray(coords[0])) {
                            coords.forEach(coord => {
                                if (Array.isArray(coord[0])) {
                                    coord.forEach(c => bounds.extend(c));
                                } else {
                                    bounds.extend(coord);
                                }
                            });
                        } else {
                            bounds.extend(coords);
                        }
                    }
                });
                insetMap.fitBounds(bounds, { padding: 40 });
            }
            insetMap.addSource('pack-fire-location', {
                type: 'geojson',
                data: {
                    type: 'Feature',
                    geometry: {
                        type: 'Point',
                        coordinates: [-118.7523402087362, 37.563]
                    }
                }
            });
            insetMap.addLayer({
                id: 'pack-fire-location',
                type: 'circle',
                source: 'pack-fire-location',
                paint: {
                    'circle-radius': 4,
                    'circle-color': '#d37020',
                    'circle-stroke-color': '#fff',
                    'circle-stroke-width': 2
                }
            });
        })
        .catch(error => {
            console.error('Error loading California state GeoJSON:', error);
        });
    });
</script>
</body>
</html>